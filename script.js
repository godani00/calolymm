// Ï†ÑÏó≠ Î≥ÄÏàò
let currentImageData = null;
let analysisResult = null;

// DOM ÏöîÏÜå Ï∞∏Ï°∞
const fileInput = document.getElementById('fileInput');
const galleryInput = document.getElementById('galleryInput');
const previewSection = document.getElementById('previewSection');
const previewImage = document.getElementById('previewImage');
const imageCanvas = document.getElementById('imageCanvas');
const loadingSection = document.getElementById('loadingSection');
const resultSection = document.getElementById('resultSection');
const errorSection = document.getElementById('errorSection');
const errorMessage = document.getElementById('errorMessage');

// Ïπ¥Î©îÎùº Ï¥¨ÏòÅ Ìï®Ïàò
function openCamera() {
    // Î™®Î∞îÏùºÏóêÏÑú Ïπ¥Î©îÎùºÍ∞Ä Ïûò ÏûëÎèôÌïòÎèÑÎ°ù ÏÑ§Ï†ï
    fileInput.setAttribute('capture', 'environment');
    fileInput.click();
}

// Í∞§Îü¨Î¶¨ ÏÑ†ÌÉù Ìï®Ïàò
function openGallery() {
    galleryInput.click();
}

// ÏÉòÌîå Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ìï®Ïàò
async function loadSampleImage(imagePath, foodName) {
    try {
        showLoading();
        
        // ÏÉòÌîå Ïù¥ÎØ∏ÏßÄÎ•º ÌîÑÎ¶¨Î∑∞Î°ú ÌëúÏãú
        previewImage.src = imagePath;
        previewImage.onload = function() {
            currentImageData = getImageBase64FromCanvas(previewImage);
            hideLoading();
            showPreview();
        };
        
        previewImage.onerror = function() {
            hideLoading();
            showError('ÏÉòÌîå Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
        };
        
    } catch (error) {
        hideLoading();
        showError('ÏÉòÌîå Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        console.error('Sample image load error:', error);
    }
}

// ÌååÏùº ÏÑ†ÌÉù Ï≤òÎ¶¨ Ìï®Ïàò
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ (10MB Ï†úÌïú)
    if (file.size > 10 * 1024 * 1024) {
        showError('ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§. 10MB Ïù¥ÌïòÏùò Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
    }

    // Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÉÄÏûÖ Ï≤¥ÌÅ¨
    if (!file.type.startsWith('image/')) {
        showError('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        previewImage.src = e.target.result;
        previewImage.onload = function() {
            currentImageData = getImageBase64FromCanvas(previewImage);
            showPreview();
        };
    };
    reader.onerror = function() {
        showError('Ïù¥ÎØ∏ÏßÄÎ•º ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
    };
    reader.readAsDataURL(file);
}

// Ï∫îÎ≤ÑÏä§Î•º ÏÇ¨Ïö©Ìï¥ Ïù¥ÎØ∏ÏßÄÎ•º base64Î°ú Î≥ÄÌôò
function getImageBase64FromCanvas(imageElement) {
    const canvas = imageCanvas;
    const ctx = canvas.getContext('2d');
    
    // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ ÏµúÏ†ÅÌôî (Î™®Î∞îÏùºÏóêÏÑú Î©îÎ™®Î¶¨ Ï†àÏïΩ)
    const maxWidth = 800;
    const maxHeight = 600;
    
    let { width, height } = imageElement;
    
    if (width > maxWidth || height > maxHeight) {
        const ratio = Math.min(maxWidth / width, maxHeight / height);
        width = width * ratio;
        height = height * ratio;
    }
    
    canvas.width = width;
    canvas.height = height;
    
    ctx.drawImage(imageElement, 0, 0, width, height);
    
    // JPEG ÌíàÏßà Ï°∞Ï†àÎ°ú ÌååÏùº ÌÅ¨Í∏∞ ÏµúÏ†ÅÌôî
    return canvas.toDataURL('image/jpeg', 0.8);
}

// API ÌÇ§ Ï≤¥ÌÅ¨ Ìï®Ïàò (Îçî Í≤¨Í≥†ÌïòÍ≤å)
function checkApiKey() {
    // config.jsÍ∞Ä Î°úÎìúÎê† ÎïåÍπåÏßÄ ÏµúÎåÄ 3Ï¥à ÎåÄÍ∏∞
    return new Promise((resolve) => {
        let attempts = 0;
        const maxAttempts = 30; // 3Ï¥à (100ms * 30)
        
        const checkKey = () => {
            if (window.GEMINI_API_KEY && window.GEMINI_API_KEY !== "YOUR_API_KEY_HERE") {
                resolve(true);
                return;
            }
            
            attempts++;
            if (attempts >= maxAttempts) {
                resolve(false);
                return;
            }
            
            setTimeout(checkKey, 100);
        };
        
        checkKey();
    });
}

// Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ìï®Ïàò
async function analyzeImage() {
    if (!currentImageData) {
        showError('Î∂ÑÏÑùÌï† Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
    }

    // API ÌÇ§ Ï≤¥ÌÅ¨ (ÌÉÄÏù¥Î∞ç Î¨∏Ï†ú Ìï¥Í≤∞)
    const hasValidApiKey = await checkApiKey();
    if (!hasValidApiKey) {
        showError('API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. config.js ÌååÏùºÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
    }

    showLoading();

    try {
        const base64Data = currentImageData.split(',')[1];
        
        const requestBody = {
            contents: [{
                parts: [
                    {
                        text: `Ïù¥ ÏùåÏãù Ïù¥ÎØ∏ÏßÄÎ•º Î∂ÑÏÑùÌïòÏó¨ Îã§Ïùå Ï†ïÎ≥¥Î•º Ï†ïÌôïÌïú JSON ÌòïÏãùÏúºÎ°ú Ï†úÍ≥µÌï¥Ï£ºÏÑ∏Ïöî:

1. ÏùåÏãù Ï¢ÖÎ•òÏôÄ Í∞ÅÍ∞ÅÏùò ÏòàÏÉÅ ÏπºÎ°úÎ¶¨ (kcal)
2. ÏπºÎ°úÎ¶¨ Í≥ÑÏÇ∞ Í≥ºÏ†ï (Ïñ¥Îñ§ Í∏∞Ï§ÄÏúºÎ°ú Í≥ÑÏÇ∞ÌñàÎäîÏßÄ)
3. Ï¥ù ÏπºÎ°úÎ¶¨Î•º ÏÜåÎ™®ÌïòÎäîÎç∞ ÌïÑÏöîÌïú Ïö¥ÎèôÎüâ (Îã¨Î¶¨Í∏∞, Í±∑Í∏∞, ÏûêÏ†ÑÍ±∞ ÌÉÄÍ∏∞, Îì±ÏÇ∞ Îì±)

ÏùëÎãµÏùÄ Î∞òÎìúÏãú Îã§Ïùå JSON ÌòïÏãùÏùÑ Ï†ïÌôïÌûà Îî∞ÎùºÏ£ºÏÑ∏Ïöî:
{
  "foods": [
    {
      "name": "ÏùåÏãùÎ™Ö",
      "calories": Ïà´Ïûê,
      "portion": "1Ïù∏Î∂Ñ"
    }
  ],
  "totalCalories": Ï¥ùÏπºÎ°úÎ¶¨Ïà´Ïûê,
  "calculationProcess": [
    "Í≥ÑÏÇ∞ Í≥ºÏ†ï ÏÑ§Î™Ö 1",
    "Í≥ÑÏÇ∞ Í≥ºÏ†ï ÏÑ§Î™Ö 2"
  ],
  "exercises": [
    {
      "name": "Ïö¥ÎèôÎ™Ö",
      "duration": "ÏãúÍ∞Ñ (Ïòà: 30Î∂Ñ, 1ÏãúÍ∞Ñ)",
      "type": "Ïö¥Îèô Ï¢ÖÎ•ò"
    }
  ]
}

ÌïúÍµ≠ÏùåÏãùÏùò Í≤ΩÏö∞ ÏùºÎ∞òÏ†ÅÏù∏ 1Ïù∏Î∂Ñ Í∏∞Ï§ÄÏúºÎ°ú, ÏÑúÏñëÏùåÏãùÏùò Í≤ΩÏö∞ ÌèâÍ∑†Ï†ÅÏù∏ ÌÅ¨Í∏∞Î°ú Í≥ÑÏÇ∞Ìï¥Ï£ºÏÑ∏Ïöî. ÏπºÎ°úÎ¶¨Îäî Î≥¥ÏàòÏ†ÅÏúºÎ°ú Í≥ÑÏÇ∞ÌïòÎêò, ÎÑàÎ¨¥ ÏóÑÍ≤©ÌïòÏßÄ ÏïäÍ≤å Ìï¥Ï£ºÏÑ∏Ïöî.`
                    },
                    {
                        inline_data: {
                            mime_type: "image/jpeg",
                            data: base64Data
                        }
                    }
                ]
            }]
        };

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${window.GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            throw new Error('API ÏùëÎãµÏóêÏÑú Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        }

        let responseText = data.candidates[0].content.parts[0].text;
        
        // JSON ÌååÏã± Ï†Ñ Ï†ïÎ¶¨
        responseText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        try {
            analysisResult = JSON.parse(responseText);
        } catch (parseError) {
            // JSON ÌååÏã± Ïã§Ìå®Ïãú Í∏∞Î≥∏ ÏùëÎãµ ÏÉùÏÑ±
            console.warn('JSON ÌååÏã± Ïã§Ìå®, Í∏∞Î≥∏ ÏùëÎãµ ÏÉùÏÑ±:', parseError);
            analysisResult = createFallbackResult(responseText);
        }

        hideLoading();
        displayResult();

    } catch (error) {
        hideLoading();
        console.error('Analysis error:', error);
        
        if (error.message.includes('API ÏöîÏ≤≠ Ïã§Ìå®')) {
            showError('API ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
        } else if (error.message.includes('API ÌÇ§')) {
            showError('API ÌÇ§Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. config.js ÌååÏùºÏùò API ÌÇ§Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
        } else {
            showError('Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
        }
    }
}

// JSON ÌååÏã± Ïã§Ìå®Ïãú Í∏∞Î≥∏ Í≤∞Í≥º ÏÉùÏÑ±
function createFallbackResult(responseText) {
    return {
        foods: [
            {
                name: "Ïù∏ÏãùÎêú ÏùåÏãù",
                calories: 300,
                portion: "1Ïù∏Î∂Ñ"
            }
        ],
        totalCalories: 300,
        calculationProcess: [
            "AIÍ∞Ä Ïù¥ÎØ∏ÏßÄÎ•º Î∂ÑÏÑùÌñàÏäµÎãàÎã§",
            "ÏùºÎ∞òÏ†ÅÏù∏ ÏùåÏãùÏùò ÌèâÍ∑† ÏπºÎ°úÎ¶¨Î•º Í≥ÑÏÇ∞ÌñàÏäµÎãàÎã§",
            "ÏïΩ 300kcalÎ°ú Ï∂îÏ†ïÎê©ÎãàÎã§"
        ],
        exercises: [
            {
                name: "Îπ†Î•∏ Í±∑Í∏∞",
                duration: "45Î∂Ñ",
                type: "Ïú†ÏÇ∞ÏÜå"
            },
            {
                name: "Îã¨Î¶¨Í∏∞",
                duration: "25Î∂Ñ",
                type: "Ïú†ÏÇ∞ÏÜå"
            }
        ]
    };
}

// Í≤∞Í≥º ÌëúÏãú Ìï®Ïàò
function displayResult() {
    if (!analysisResult) return;

    // ÏùåÏãù ÏïÑÏù¥ÌÖú ÌëúÏãú
    const foodItemsContainer = document.getElementById('foodItems');
    foodItemsContainer.innerHTML = '';
    
    if (analysisResult.foods && analysisResult.foods.length > 0) {
        analysisResult.foods.forEach(food => {
            const foodItem = document.createElement('div');
            foodItem.className = 'food-item';
            foodItem.innerHTML = `
                <span class="food-name">${food.name} ${food.portion || ''}</span>
                <span class="food-calories">${food.calories}kcal</span>
            `;
            foodItemsContainer.appendChild(foodItem);
        });
    }

    // Ï¥ù ÏπºÎ°úÎ¶¨ ÌëúÏãú
    document.getElementById('totalCalories').textContent = analysisResult.totalCalories || 0;

    // Í≥ÑÏÇ∞ Í≥ºÏ†ï ÌëúÏãú
    const calculationContainer = document.getElementById('calculationProcess');
    if (analysisResult.calculationProcess && analysisResult.calculationProcess.length > 0) {
        calculationContainer.innerHTML = `
            <h4>üîç Í≥ÑÏÇ∞ Í≥ºÏ†ï</h4>
            <ul>
                ${analysisResult.calculationProcess.map(process => `<li>${process}</li>`).join('')}
            </ul>
        `;
    } else {
        calculationContainer.innerHTML = '';
    }

    // Ïö¥Îèô Í∂åÏû•Îüâ ÌëúÏãú
    const exerciseContainer = document.getElementById('exerciseRecommendations');
    if (analysisResult.exercises && analysisResult.exercises.length > 0) {
        exerciseContainer.innerHTML = `
            <h4>üèÉ‚Äç‚ôÄÔ∏è ÏπºÎ°úÎ¶¨ ÏÜåÎ™® Ïö¥ÎèôÎüâ</h4>
            ${analysisResult.exercises.map(exercise => `
                <div class="exercise-item">
                    <span class="exercise-name">${exercise.name}</span>
                    <span class="exercise-duration">${exercise.duration}</span>
                </div>
            `).join('')}
        `;
    } else {
        exerciseContainer.innerHTML = '';
    }

    showResult();
}

// Í≤∞Í≥º Î≥µÏÇ¨ Ìï®Ïàò
function copyResult() {
    if (!analysisResult) return;

    let copyText = `üçΩÔ∏è ÏπºÎ°úÎ¶¨ Î∂ÑÏÑù Í≤∞Í≥º\n\n`;
    
    if (analysisResult.foods && analysisResult.foods.length > 0) {
        copyText += `üìã Ïù∏ÏãùÎêú ÏùåÏãù:\n`;
        analysisResult.foods.forEach(food => {
            copyText += `‚Ä¢ ${food.name} ${food.portion || ''}: ${food.calories}kcal\n`;
        });
        copyText += `\n`;
    }
    
    copyText += `üî• Ï¥ù ÏòàÏÉÅ ÏπºÎ°úÎ¶¨: ${analysisResult.totalCalories}kcal\n\n`;
    
    if (analysisResult.exercises && analysisResult.exercises.length > 0) {
        copyText += `üèÉ‚Äç‚ôÄÔ∏è ÏπºÎ°úÎ¶¨ ÏÜåÎ™® Ïö¥ÎèôÎüâ:\n`;
        analysisResult.exercises.forEach(exercise => {
            copyText += `‚Ä¢ ${exercise.name}: ${exercise.duration}\n`;
        });
    }

    // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(copyText).then(() => {
            alert('Í≤∞Í≥ºÍ∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
        }).catch(() => {
            fallbackCopyToClipboard(copyText);
        });
    } else {
        fallbackCopyToClipboard(copyText);
    }
}

// ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ ÎåÄÏ≤¥ Ìï®Ïàò (Íµ¨Ìòï Î∏åÎùºÏö∞Ï†ÄÏö©)
function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        alert('Í≤∞Í≥ºÍ∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
    } catch (err) {
        console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå®:', err);
        alert('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í≤∞Í≥ºÎ•º ÏàòÎèôÏúºÎ°ú Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.');
    }
    
    document.body.removeChild(textArea);
}

// Ïï± Ï¥àÍ∏∞Ìôî Ìï®Ïàò
function resetApp() {
    currentImageData = null;
    analysisResult = null;
    
    // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
    fileInput.value = '';
    galleryInput.value = '';
    
    // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
    hideAllSections();
}

// UI ÌëúÏãú/Ïà®ÍπÄ Ìï®ÏàòÎì§
function showPreview() {
    hideAllSections();
    previewSection.style.display = 'block';
}

function showLoading() {
    hideAllSections();
    loadingSection.style.display = 'block';
}

function hideLoading() {
    loadingSection.style.display = 'none';
}

function showResult() {
    hideAllSections();
    resultSection.style.display = 'block';
}

function showError(message) {
    hideAllSections();
    
    // Í∏∞Î≥∏ ÏóêÎü¨ Î©îÏãúÏßÄ ÏÑ§Ï†ï
    let fullMessage = message;
    
    // API ÌÇ§ Í¥ÄÎ†® ÏóêÎü¨Ïù∏ Í≤ΩÏö∞ Îçî ÏûêÏÑ∏Ìïú Ï†ïÎ≥¥ Ï†úÍ≥µ
    if (message.includes('API ÌÇ§')) {
        fullMessage = `${message}\n\nÎ™®Î∞îÏùºÏóêÏÑú Ï†ëÏÜç Ï§ëÏù¥ÏãúÎùºÎ©¥:\n1. PC IP Ï£ºÏÜåÎ°ú Ï†ëÏÜçÌïòÏÑ∏Ïöî: 192.168.1.125:8000\n2. Î∏åÎùºÏö∞Ï†ÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥ Î≥¥ÏÑ∏Ïöî\n3. Ï∫êÏãúÎ•º ÏÇ≠Ï†úÌï¥ Î≥¥ÏÑ∏Ïöî`;
        
        // ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ Ï∂îÍ∞Ä (Î™®Î∞îÏùºÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•)
        if (window.DEBUG_MODE) {
            fullMessage += `\n\n[ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥]\n- API ÌÇ§ Ï°¥Ïû¨: ${!!window.GEMINI_API_KEY}\n- Config Î°úÎìúÎê®: ${typeof window.API_CONFIG !== 'undefined'}\n- ÌòÑÏû¨ URL: ${window.location.href}\n- ÏÇ¨Ïö©Ïûê ÏóêÏù¥Ï†ÑÌä∏: ${navigator.userAgent.includes('Mobile') ? 'Î™®Î∞îÏùº' : 'Îç∞Ïä§ÌÅ¨ÌÜ±'}`;
        }
    }
    
    errorMessage.style.whiteSpace = 'pre-line';
    errorMessage.textContent = fullMessage;
    errorSection.style.display = 'block';
}

function hideAllSections() {
    previewSection.style.display = 'none';
    loadingSection.style.display = 'none';
    resultSection.style.display = 'none';
    errorSection.style.display = 'none';
}

// Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏóêÎü¨ Ï≤òÎ¶¨
function handleImageError(img) {
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiPuydtOuvuOyngCDsl4bsnYw8L3RleHQ+PC9zdmc+';
}

// Ïï± Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', async function() {
    // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
    hideAllSections();
    
    // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ ÏµúÏ†ÅÌôî (Î™®Î∞îÏùº ÏÑ±Îä• Ìñ•ÏÉÅ)
    document.addEventListener('touchstart', function() {}, {passive: true});
    
    console.log('ÏπºÎ°úÎ¶¨M Ïï±Ïù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
    
    // API ÌÇ§ ÏÉÅÌÉú ÌôïÏù∏ Î∞è Î°úÍπÖ
    setTimeout(async () => {
        const hasValidApiKey = await checkApiKey();
        if (window.debugLog) {
            window.debugLog('Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å', {
                hasApiKey: hasValidApiKey,
                apiKeyValue: window.GEMINI_API_KEY ? '[ÏÑ§Ï†ïÎê®]' : '[ÏóÜÏùå]',
                userAgent: navigator.userAgent,
                screenSize: `${screen.width}x${screen.height}`,
                viewportSize: `${window.innerWidth}x${window.innerHeight}`
            });
        }
        
        if (!hasValidApiKey) {
            console.warn('‚ö†Ô∏è API ÌÇ§ ÌôïÏù∏ ÌïÑÏöî:', {
                hasWindow: !!window,
                hasGeminiKey: !!window.GEMINI_API_KEY,
                keyValue: window.GEMINI_API_KEY,
                configLoaded: typeof window.API_CONFIG !== 'undefined'
            });
        }
    }, 500);
});